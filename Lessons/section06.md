## Streaming

- OTT 서비스들은 영화나 드라마처럼 아주 큰 용량의 동영상을 굉장히 빠른 속도로 시청할 수 있도록 만들어 주기 때문에 오늘날 굉장히 많은 사람들에게 사랑을 받고 있다.이 모든 것들을 가능케 하는 것이 바로 스트리밍이라는 기술이다.
- 스트리밍이라는 기술은 서버에서 클라이언트로 어떠한 데이터를 넘겨줘야 될 때 보내줘야하는 데이터의 크기가 너무나도 크거나 또는 서버 측에서 데이터를 준비하는데 걸리는 시간이 꽤나 오래 걸리게 되어서 데이터를 빠르게 전송해주기 어려울 것 같을 때, 전송할 데이터를 여러 개의 조각으로 잘게 쪼갠 다음 쪼개진 작은 용량의 데이터들을 마치 강물에 하나씩 흘려보내듯이 하나하나씩 클라이언트에게 전송하하는 기술을 바로 스트리밍이라고 한다.

  <img width='700px' src='https://github.com/user-attachments/assets/d5137f40-682e-4101-a9df-f6fe700a533e'>
  <img width='700px' src='https://github.com/user-attachments/assets/ad4f743e-777a-4be3-a404-ecebe56d75d0'>

  > 스트림(stream): 개천, 하천

- 다시 말해서 스트리밍이란 어떠한 강물이나 개천을 통해서 물자를 보내듯 잘게 쪼개진 데이터들을 연속적으로 보내주는 기술을 의미한다.
- 스트리밍 기술을 이용하면 데이터가 다 불러와 지지 않은 상태에서도 일단 지금까지 전달받은 데이터에 접근할 수 있기 때문에 결과적으로 사용자에게 긴 로딩 없이 굉장히 좋은 사용자 경험을 제공할 수 있다.

  <img width='700px' src='https://github.com/user-attachments/assets/e7a82daa-e941-4978-afa9-06c94d530795'>
  <img width='700px' src='https://github.com/user-attachments/assets/a232d3b0-d972-44d5-bccd-27cca59e4f7b'>
  <img width='700px' src='https://github.com/user-attachments/assets/3585d074-ba43-4d1d-9bd7-c93eda98dcc9'>

  > HTML 페이지 스트리밍 동작 방식

- Next.js는 이러한 스트리밍이라는 기술의 이점을 동영상 뿐만 아니라 일반적인 웹 서비스에서도 동일하게 누릴 수 있게끔 `HTML 페이지를 스트리밍`하는 기능을 자체적으로 제공하고 있다. 이를 통해서 사용자가 특정 페이지에 접속했을 때 일단 빠르게 렌더링이 오래 걸리지 않는 단순한 컴포넌트들부터 먼저 화면에 보여주고, 데이터 패칭 등의 이유로 렌더링이 오래 걸릴 것으로 예상되는 컴포넌들은 일단 로딩바 같은 대체 UI를 화면에 보여주고 있다가 서버 측에서 컴포넌트의 렌더링이 완료가 되면 그때 뒤는게 해당 컴포넌트들만 따로 전달해서 콘텐츠를 보여주는 방식으로 페이지를 제공할 수 있게 된다.
- 스트리밍을 이용하게 되면 페이지 내부에 렌더링 하는데 아무리 오래 걸리는 컴포넌트가 포함되어 있다고 하더라도 사용자들에게는 일단 뭐라도 빠르게 렌더링할 수 있는 컴포넌트들이라도 보여줄 수 있기 때문에 높은 응답성으로 긍적적인 사용자 경험이 제공하게 된다.
- 서치 페이지를 예로 들면 백엔드 서버로부터 비동기적으로 검색 결과 데이터를 불러오는 페이지 컴포넌트는 브라우저로부터 서치 페이지를 요청 받았을 때, `Streaming`을 적용하지 않는다면 포함된 4개의 컴포넌트들 모두 한 번씩 다 렌더링을 마친 이후에 브라우저에게 페이지를 응답하게 될 것이다. 만약 페이지 컴포넌트에서 수행하는 비동기 작업 데이터를 불러오는 작업이 오래 걸리게 될 경우에는 페이지의 응답 자체가 전체적으로 다 느려지게 되는 문제점이 존재했다.
- 그러나 `Streaming`을 적용하게 되면 비동기적으로 데이터를 불러오고 있는 페이지 컴포넌트의 렌더링 결과는 제외하고 나머지 루트 레이아웃, 서치바 레이아웃, 서치바 컴포넌트 같은 즉시 렌더링할 수 있는 컴포넌트의 결과만 브라우저에게 응답해서 일단 빠르게 화면을 보여주고, 비동기적으로 데이터를 불러오고 있는 페이지 컴포넌트 부분은 로딩바 같은 대체 UI를 보여주고 있다가 뒤늦게 페이지 컴포넌트의 렌더링이 완료되면 그제서야 후속으로 페이지 컴포넌트의 내용을 화면에 렌더링하게 되는 방식으로 동작하게 된다.

  <img width='700px' src='(https://github.com/user-attachments/assets/1dc899d6-5887-41a3-912e-a873a18dc263'>
  <img width='700px' src='https://github.com/user-attachments/assets/be68573d-de79-4bd3-9a7e-21a81f154ce6'>
  
  > 서치 페이지의 컴포넌트 구조

- 스트리밍이란 쉽게 말해 특정 페이지를 렌더링할 때 비동기 작업이 없는 빠르게 렌더링 될 수 있는 컴포넌트들부터 즉시 브라우저에 렌더링한 뒤 비동기 작업을 포함하고 있는 비교적 렌더링 시간이 오래 걸리는 컴포넌트의 렌더링 결과를 뒤늦게 페이지에 보내주게 되는 동작 방식을 `Streaming`이라고 부른다.
- 이런 Next.js의 `Streaming`은 Dynamic Page에 자주 활용이 된다. Dynamic Page들은 Next.js 서버에서 빌드타임에 생성이 되지 않기 때문에 `Full Route Cache`에는 저장이 되지 않는다. (Static Page만 저장됨) 그렇기 때문에 서치 페이지 같은 다이나믹 페이지들은 브라우저 접속 요청이 들어왔을 때 마다 Next 서버가 페이지의 모든 컴포넌트들을 다 실행해서 페이지를 매번 새롭게 렌더링 해줘야 되기 때문에 이 과정에서 특정 컴포넌트 내부에서 발생하는 서치 API 같은 데이터 페칭이 너무 오래 걸려 버리게 될 경우에 너무 오래 걸려 버리게 될 경우에는 전체 페이지의 응답이 느려지게 되어서 결국에 좋지 않은 사용자 경험을 제공하게 된다.
- 바로 이런 상황에 Next.js의 스트리밍이 필요하게 된다.

  <img width='700px' src='https://github.com/user-attachments/assets/28c0853d-6412-4687-a934-4baac580fcf3'>
  <img width='700px' src='https://github.com/user-attachments/assets/e9cbaed7-4f6e-46e7-b957-44790e89c69a'>
  <img width='700px' src='https://github.com/user-attachments/assets/c3759e38-631d-41b2-afdb-998b295006dc'>
  <img width='700px' src='https://github.com/user-attachments/assets/6844367f-c96e-4a7d-b906-1fbda7e479d2'>

  > 좋지 않은 사용자 경험을 제공하는 Dynamic 페이지의 단점을 해결하는 Streaming

- 페이지 접속 요청이 들어왔을 때 빠르게 오래 걸리지 않는 컴포넌트들만 빠르게 렌더링해서 곧바로 브라우저에 응답해 줌으로써 사용자에게 빈 화면 대신에 일단 레이아웃처럼 빠르게 렌더링할 수 있는 부분들이라도 보여주고, 오래 걸리는 부분들은 로딩바 같은 대체 UI를 보여주고 있다가 Next.js 서버 측에서 데이터 페칭이 완료가 되어서 오래 걸리는 컴포넌트들까지 렌더링이 완료가 되었다면 그때는 후속으로 렌더링된 데이터를 보내줌으로써 실제 데이터를 채워 넣어서 사용자가 로딩 화면을 조금이라도 덜 지루하게 느낄 수 있도록 좋은 사용자 경험을 제공할 수 있게 된다.
- 스트리밍은 마치 비유해보자면 식당에서 어떠한 음식점에 방문을 했을 때 메인 메뉴를 기다리는 동안에 밑반찬이나 물부터 빠르게 점원분이 가져다 주는 것과 유사하다고 생각하면 된다. 밑반찬이 빠르게 나오게 되면 메인 메뉴가 조금 오래 걸리게 되더라도 밑반찬을 먹으면서 기다리면 되기 때문에 꽤나 인내심이 생기게 된다.
- Next.js의 `Streaming`도 오래 걸리는 Dynamic Page 유형의 서버 컴포넌트 렌더링을 사용자가 조금 더 좋은 환경에서 인내심을 가지고 기다릴 수 있도록 빠르게 렌더링이 가능한 컴포넌트들을 밑반찬 처럼 내보재주는 것이라고 이해해볼 수 있다.

### 페이지 스트리밍 적용하기

- 특정 페이지 컴포넌트를 `Streaming` 하도록 설정하려면 해당 페이지 컴포넌트와 동일한 경로에 새로운 파일로 `loading.tsx` 라는 새로운 파일을 하나 만들어 주면 된다. `loading.tsx` 컴포넌트에는 대체 UI 역할을 할 로딩바 같은 역할을 할 요소를 리턴해주면 이제 같은 경로의 `page.tsx` 페이지 컴포넌트는 스트리밍 되도록 자동 설정이 되며, 로딩되는 동안에는 대체 UI로써 `loading.tsx` 파일에 작성한 로딩 컴포넌트가 화면에 대신 렌더링된다.
- 그런데 백엔드 서버와 Next App이 지금 너무 빠르다. 왜냐하면 PC에서 둘다 함께 동작하고 있기 때문에 네트워크 요청을 주고 받는 속도가 굉장히 빠른 상태이다. 데이터를 굉장히 빠르게 불러오기 때문에 로딩 UI를 볼 시간이 없다. 그래서 먼저 페이지 컴포넌트 내부에 강제로 데이터를 불러오는 과정을 지연시키기 위해서 딜레이를 발생시키는 함수를 하나 만들어준다.

  ```typescript
  // /src/util/delay.ts
  export async function delay(ms: number) {
    return new Promise((resolve) => {
      setTimeout(() => {
        resolve('');
      }, ms);
    });
  }
  // /src/app/(with-searchbar)/search/page.tsx
  ...
  await delay(1500); // 1.5초
  ...
  ```

  <img width='500px' src='https://github.com/user-attachments/assets/04c0f2bb-1a6a-4f95-a1c7-1529f4d95269'>

  > 스크리밍 설정되어 대체 UI가 나오는 보여짐

- 스트리밍을 페이지 컴포넌트에 적용하려면 프로젝트 내 같은 경로에 `loading.tsx`라는 파일을 추가로 생성해줌으로써 같은 경로의 페이지 컴포넌트를 스트리밍 되도록 설정을 해주면, 혹여나 딜레이가 발생함으로써 페이지 컴포넌트를 렌더링하는 데에 굉장히 오랜 시간이 소요가 된다고 하더라도 전체 페이지의 렌더링 자체를 지연시키지는 않기 때문에 페이지 컴포넌트가 아닌 그 외의 비동기 작업이 없는 레이아웃과 같은 컴포넌트들은 화면에 지체 없이 바로 나타나게 될 것이다. 이런 매커니즘을 통해 훨씬 더 좋은 사용자 경험을 제공할 수 있다.

### loading.tsx 파일의 주의할 점 (1)

- `loading.tsx` 파일은 동일한 경로에 있는 페이지 컴포넌트만 스트리밍 되도록 설정하는 것이 아니라 마치 레이아웃 파일처럼 **하위 경로 모든 비동기 페이지 컴포넌트들이 다 스트리밍이 되도록 설정**이 된다. 그렇기 때문에 만약 프로젝트의 서치 폴더 아래 새로운 경로 `/search/setting/page.tsx`가 있다면 setting 페이지 역시 상위 경로에 있는 `loading.tsx` 파일 때문에 자동으로 스트리밍 되도록 설정이 된다. 또한 로딩 중에 대체 UI 또한 로딩 컴포넌트로 동일하게 설정이 된다.
  ```tsx
  import { delay } from '@util/delay';
  export default async function Page() {
    await delay(2000);
    return <div>setting page</div>;
  }
  ```

### loading.tsx 파일의 주의할 점 (2)

- `loading.tsx`파일이 스트리밍하도록 설정하는 페이지 컴포넌트는 모든 페이지 컴포넌트가 아닌, `async` 키워드가 붙어서 비동기로 작동하도록 설정된 페이지 컴포넌트에만 스트리밍을 제공한다.
- 왜냐하면 비동기 컴포넌트가 아니라면 데이터를 불러오지 않고 있다는 뜻이기 때문에 그런 컴포넌트들은 고정된 UI를 렌더링하기 위해 사용된다. 다시말해 `async` 키워드가 붙지 않는 비동기 컴포넌트가 아닌 컴포넌트는 `loading.tsx`가 존재한다고 하더라도 스트리밍 되지 않는다.
- 실험을 하며 만들어둔 setting 페이지 컴포넌트에서 딜레이를 제거하고, `async` 키워드도 붙어있지 않은 동기적인 컴포넌트로 만들어주면 스트리밍이 적용되지 않고 바로 setting 페이지 컴포넌트가 렌더링 됨을 확인할 수 있다.

### loading.tsx 파일의 주의할 점 (3)

- `loading.tsx`라는 파일은 무조건 페이지 컴포넌트에만 스트리밍을 적용할 수 있다.
- 그렇기 때문에 레이아웃이나 또는 서치 페이지에 들어가는 `components`폴더의 book-item이나 searchbar 같은 일반적인 컴포넌트들에는 `loading.tsx`파일로는 스트리밍을 설정할 수 없다.
- 만약 페이지 컴포넌트가 아닌 별도의 컴포넌트들에도 스트리밍을 적용하고 싶다면, loading.tsx 파일을 이용하면 안되고 대신에 React의 Suspense 라는 컴포넌트를 별도로 활용해주어야 한다.

### loading.tsx 파일의 주의할 점 (4)

- loading.tsx 파일로 설정된 스트리밍은 브라우저에서 쿼리스트링이 변경될 때에는 트리거링 되지 않는다.
- 인덱스 페이지에서 서치 페이지로 경로 자체가 바뀌면 `loading.tsx` 파일의 스트리밍이 정상 동작하지만, 대신에 경로상에서 쿼리스트링망 변경하면 스트리밍이 적용되지 않는다.
- 이렇게 되면 별로 사용자 경험이 좋지 않다. 이런 경우에도 스트리밍이 똑같이 동작하도록 만들고 싶다면 이번에도 역시 리액트 Suspense 컴포넌트를 이용해 주어야 한다.

## 컴포넌트 스트리밍 적용하기

-
